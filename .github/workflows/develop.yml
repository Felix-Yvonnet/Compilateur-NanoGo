name: OCaml Formatting and Testing

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install OCaml and opam
        run: |
          sudo apt-get update
          sudo apt-get install -y ocaml opam
      - name: Initialize opam and set OCaml version
        run: |
          opam init --bare
          opam switch create 4.09.1
          eval $(opam env)
      - name: Install ocamlformat
        run: |
          opam install --yes ocamlformat
      - name: Format code
        run: |
          # Find all modified OCaml files in the push
          MODIFIED_OCAML_FILES=$(git diff --name-only HEAD HEAD~1 -- '*.ml' '*.mli')
          # Format each modified OCaml file
          for file in $MODIFIED_OCAML_FILES; do
            ocamlformat -i "$file"
          done
      - name: Check formatting
        run: |
          git diff --exit-code
          if [ $? -ne 0 ] ; then
            exit 1
          fi
      - name: Run tests
        run: |
          chmod +x ./tests/launch.sh
          ./tests/launch.sh
          if [ $? -ne 0 ] ; then
            exit 1
          fi
